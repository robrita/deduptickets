openapi: 3.1.0
info:
  title: DedupTickets API
  description: API for the Ticket Deduplication & Clustering Dashboard
  version: 1.0.0
  contact:
    name: DedupTickets Team

servers:
  - url: /api/v1
    description: API v1

security:
  - ApiKeyAuth: []

tags:
  - name: Tickets
    description: Ticket ingestion and retrieval
  - name: Clusters
    description: Cluster management
  - name: Merges
    description: Merge and revert operations
  - name: Spikes
    description: Spike detection and alerts
  - name: Trends
    description: Trend and driver analysis
  - name: Audit
    description: Audit log access

paths:
  /health:
    get:
      summary: Health check
      operationId: healthCheck
      security: []
      responses:
        '200':
          description: Service is healthy
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/HealthResponse'

  # ==================== TICKETS ====================
  /tickets:
    post:
      tags: [Tickets]
      summary: Ingest a new ticket
      operationId: ingestTicket
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TicketCreate'
      responses:
        '201':
          description: Ticket ingested successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ticket'
        '400':
          $ref: '#/components/responses/BadRequest'
        '409':
          description: Ticket with external_id already exists
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    get:
      tags: [Tickets]
      summary: List tickets with filtering
      operationId: listTickets
      parameters:
        - $ref: '#/components/parameters/PageOffset'
        - $ref: '#/components/parameters/PageLimit'
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/TicketStatus'
        - name: channel
          in: query
          schema:
            type: string
            enum: [in_app, chat, email, social, phone]
        - name: category
          in: query
          schema:
            type: string
        - name: merchant
          in: query
          schema:
            type: string
          description: Filter by merchant/bank name
        - name: region
          in: query
          schema:
            type: string
          description: Filter by region
        - name: created_after
          in: query
          schema:
            type: string
            format: date-time
        - name: created_before
          in: query
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Paginated list of tickets
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TicketListResponse'

  /tickets/{ticket_id}:
    get:
      tags: [Tickets]
      summary: Get ticket by ID
      operationId: getTicket
      parameters:
        - $ref: '#/components/parameters/TicketId'
      responses:
        '200':
          description: Ticket details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Ticket'
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== CLUSTERS ====================
  /clusters:
    get:
      tags: [Clusters]
      summary: List clusters
      operationId: listClusters
      parameters:
        - $ref: '#/components/parameters/PageOffset'
        - $ref: '#/components/parameters/PageLimit'
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/ClusterStatus'
        - name: confidence
          in: query
          schema:
            $ref: '#/components/schemas/ConfidenceLevel'
        - name: min_ticket_count
          in: query
          schema:
            type: integer
            minimum: 2
      responses:
        '200':
          description: Paginated list of clusters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClusterListResponse'

  /clusters/{cluster_id}:
    get:
      tags: [Clusters]
      summary: Get cluster details with member tickets
      operationId: getCluster
      parameters:
        - $ref: '#/components/parameters/ClusterId'
      responses:
        '200':
          description: Cluster with member tickets
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ClusterDetail'
        '404':
          $ref: '#/components/responses/NotFound'

  /clusters/{cluster_id}/dismiss:
    post:
      tags: [Clusters]
      summary: Dismiss a cluster suggestion
      operationId: dismissCluster
      parameters:
        - $ref: '#/components/parameters/ClusterId'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
                  description: Optional reason for dismissal
      responses:
        '200':
          description: Cluster dismissed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cluster'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Cluster already actioned (merged/dismissed)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

  /clusters/{cluster_id}/members/{ticket_id}:
    delete:
      tags: [Clusters]
      summary: Remove a ticket from a cluster
      operationId: removeClusterMember
      parameters:
        - $ref: '#/components/parameters/ClusterId'
        - $ref: '#/components/parameters/TicketId'
      responses:
        '200':
          description: Ticket removed from cluster
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Cluster'
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== MERGES ====================
  /merges:
    post:
      tags: [Merges]
      summary: Merge tickets in a cluster
      operationId: mergeCluster
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/MergeRequest'
      responses:
        '201':
          description: Merge completed successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MergeOperation'
        '400':
          $ref: '#/components/responses/BadRequest'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Cluster already merged or dismissed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

    get:
      tags: [Merges]
      summary: List merge operations
      operationId: listMerges
      parameters:
        - $ref: '#/components/parameters/PageOffset'
        - $ref: '#/components/parameters/PageLimit'
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/MergeStatus'
        - name: performed_after
          in: query
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Paginated list of merge operations
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MergeListResponse'

  /merges/{merge_id}:
    get:
      tags: [Merges]
      summary: Get merge operation details
      operationId: getMerge
      parameters:
        - $ref: '#/components/parameters/MergeId'
      responses:
        '200':
          description: Merge operation details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MergeOperation'
        '404':
          $ref: '#/components/responses/NotFound'

  /merges/{merge_id}/revert:
    post:
      tags: [Merges]
      summary: Revert a merge operation
      operationId: revertMerge
      parameters:
        - $ref: '#/components/parameters/MergeId'
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                reason:
                  type: string
                  description: Reason for reverting
      responses:
        '200':
          description: Merge reverted successfully
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/MergeOperation'
        '404':
          $ref: '#/components/responses/NotFound'
        '409':
          description: Merge already reverted
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '422':
          description: Revert conflict detected
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/RevertConflictResponse'

  # ==================== SPIKES ====================
  /spikes:
    get:
      tags: [Spikes]
      summary: List spike alerts
      operationId: listSpikes
      parameters:
        - $ref: '#/components/parameters/PageOffset'
        - $ref: '#/components/parameters/PageLimit'
        - name: status
          in: query
          schema:
            $ref: '#/components/schemas/SpikeStatus'
        - name: severity
          in: query
          schema:
            $ref: '#/components/schemas/SeverityLevel'
        - name: field_name
          in: query
          schema:
            type: string
        - name: detected_after
          in: query
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Paginated list of spike alerts
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SpikeListResponse'

  /spikes/{spike_id}:
    get:
      tags: [Spikes]
      summary: Get spike alert details
      operationId: getSpike
      parameters:
        - $ref: '#/components/parameters/SpikeId'
      responses:
        '200':
          description: Spike alert with related clusters
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SpikeDetail'
        '404':
          $ref: '#/components/responses/NotFound'

  /spikes/{spike_id}/acknowledge:
    post:
      tags: [Spikes]
      summary: Acknowledge a spike alert
      operationId: acknowledgeSpike
      parameters:
        - $ref: '#/components/parameters/SpikeId'
      responses:
        '200':
          description: Spike acknowledged
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SpikeAlert'
        '404':
          $ref: '#/components/responses/NotFound'

  /spikes/{spike_id}/resolve:
    post:
      tags: [Spikes]
      summary: Resolve a spike alert
      operationId: resolveSpike
      parameters:
        - $ref: '#/components/parameters/SpikeId'
      responses:
        '200':
          description: Spike resolved
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/SpikeAlert'
        '404':
          $ref: '#/components/responses/NotFound'

  # ==================== TRENDS ====================
  /trends/top-drivers:
    get:
      tags: [Trends]
      summary: Get top recurring drivers
      operationId: getTopDrivers
      parameters:
        - name: period
          in: query
          schema:
            type: string
            enum: [day, week, month]
            default: week
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 10
      responses:
        '200':
          description: Top drivers ranked by frequency
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/TopDriversResponse'

  /trends/fastest-growing:
    get:
      tags: [Trends]
      summary: Get fastest growing drivers
      operationId: getFastestGrowing
      parameters:
        - name: compare_period
          in: query
          schema:
            type: string
            enum: [day, week, month]
            default: week
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 10
      responses:
        '200':
          description: Drivers sorted by growth rate
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GrowingDriversResponse'

  /trends/most-duplicated:
    get:
      tags: [Trends]
      summary: Get drivers with highest duplication rate
      operationId: getMostDuplicated
      parameters:
        - name: period
          in: query
          schema:
            type: string
            enum: [day, week, month]
            default: week
        - name: limit
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 10
      responses:
        '200':
          description: Drivers ranked by duplication rate
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/DuplicatedDriversResponse'

  # ==================== AUDIT ====================
  /audit:
    get:
      tags: [Audit]
      summary: Search audit logs
      operationId: searchAuditLogs
      parameters:
        - $ref: '#/components/parameters/PageOffset'
        - $ref: '#/components/parameters/PageLimit'
        - name: action_type
          in: query
          schema:
            $ref: '#/components/schemas/AuditActionType'
        - name: actor_id
          in: query
          schema:
            type: string
        - name: resource_type
          in: query
          schema:
            type: string
        - name: resource_id
          in: query
          schema:
            type: string
            format: uuid
        - name: created_after
          in: query
          schema:
            type: string
            format: date-time
        - name: created_before
          in: query
          schema:
            type: string
            format: date-time
      responses:
        '200':
          description: Paginated audit log entries
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditListResponse'

  /audit/{entry_id}:
    get:
      tags: [Audit]
      summary: Get audit entry details
      operationId: getAuditEntry
      parameters:
        - name: entry_id
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Audit entry details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/AuditEntry'
        '404':
          $ref: '#/components/responses/NotFound'

components:
  securitySchemes:
    ApiKeyAuth:
      type: apiKey
      in: header
      name: X-API-Key

  parameters:
    PageOffset:
      name: offset
      in: query
      schema:
        type: integer
        minimum: 0
        default: 0
    PageLimit:
      name: limit
      in: query
      schema:
        type: integer
        minimum: 1
        maximum: 100
        default: 20
    TicketId:
      name: ticket_id
      in: path
      required: true
      schema:
        type: string
        format: uuid
    ClusterId:
      name: cluster_id
      in: path
      required: true
      schema:
        type: string
        format: uuid
    MergeId:
      name: merge_id
      in: path
      required: true
      schema:
        type: string
        format: uuid
    SpikeId:
      name: spike_id
      in: path
      required: true
      schema:
        type: string
        format: uuid

  responses:
    BadRequest:
      description: Invalid request parameters
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'
    NotFound:
      description: Resource not found
      content:
        application/json:
          schema:
            $ref: '#/components/schemas/ErrorResponse'

  schemas:
    # ==================== COMMON ====================
    HealthResponse:
      type: object
      required: [status, version]
      properties:
        status:
          type: string
          enum: [healthy]
        version:
          type: string
        timestamp:
          type: string
          format: date-time

    ErrorResponse:
      type: object
      required: [error, message]
      properties:
        error:
          type: string
        message:
          type: string
        details:
          type: object

    PaginationMeta:
      type: object
      required: [total, offset, limit]
      properties:
        total:
          type: integer
        offset:
          type: integer
        limit:
          type: integer
        has_more:
          type: boolean

    # ==================== ENUMS ====================
    TicketStatus:
      type: string
      enum: [open, in_progress, resolved, closed, merged]

    ClusterStatus:
      type: string
      enum: [pending, merged, dismissed, expired]

    ConfidenceLevel:
      type: string
      enum: [high, medium, low]

    MergeBehavior:
      type: string
      enum: [keep_latest, combine_notes, retain_all]

    MergeStatus:
      type: string
      enum: [completed, reverted]

    SpikeStatus:
      type: string
      enum: [active, acknowledged, resolved]

    SeverityLevel:
      type: string
      enum: [low, medium, high]

    AuditActionType:
      type: string
      enum: [merge, revert, cluster_create, cluster_dismiss, cluster_member_remove, ticket_create, ticket_update, spike_detect, spike_acknowledge, spike_resolve]

    # ==================== TICKETS ====================
    TicketCreate:
      type: object
      required: [ticket_number, summary, status, channel, region, category, created_at]
      properties:
        ticket_number:
          type: string
          maxLength: 50
          description: External ticket ID from source system
        customer_id:
          type: string
          maxLength: 100
          description: Customer identifier
        summary:
          type: string
          maxLength: 500
          description: Brief issue description
        description:
          type: string
          description: Detailed issue description
        status:
          $ref: '#/components/schemas/TicketStatus'
        priority:
          type: string
          enum: [low, medium, high, urgent]
        severity:
          type: string
          enum: [s1, s2, s3, s4]
          description: Issue severity level
        channel:
          type: string
          enum: [in_app, chat, email, social, phone]
          description: Support channel
        category:
          type: string
          maxLength: 100
          description: Issue category
        subcategory:
          type: string
          maxLength: 100
          description: Issue subcategory
        region:
          type: string
          maxLength: 100
          description: Geographic region
        city:
          type: string
          maxLength: 100
        transaction_id:
          type: string
          maxLength: 100
          description: Related transaction ID
        amount:
          type: number
          description: Transaction amount
        currency:
          type: string
          maxLength: 10
          description: Currency code (PHP, USD, etc.)
        merchant:
          type: string
          maxLength: 255
          description: Bank or merchant name
        occurred_at:
          type: string
          format: date-time
          description: When the issue occurred
        created_at:
          type: string
          format: date-time
        raw_metadata:
          type: object

    Ticket:
      allOf:
        - $ref: '#/components/schemas/TicketCreate'
        - type: object
          required: [id, created_at, updated_at]
          properties:
            id:
              type: string
              format: uuid
            cluster_id:
              type: string
              format: uuid
              description: Associated cluster ID if clustered
            merged_into_id:
              type: string
              format: uuid
              description: If merged, points to primary ticket
            closed_at:
              type: string
              format: date-time
            updated_at:
              type: string
              format: date-time

    TicketListResponse:
      type: object
      required: [data, meta]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Ticket'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    # ==================== CLUSTERS ====================
    MatchingSignals:
      type: object
      properties:
        exact_matches:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              value:
                type: string
        time_window:
          type: object
          properties:
            start:
              type: string
              format: date-time
            end:
              type: string
              format: date-time
        text_similarity:
          type: object
          properties:
            score:
              type: number
              format: float
            common_terms:
              type: array
              items:
                type: string
        field_matches:
          type: array
          items:
            type: object
            properties:
              field:
                type: string
              value:
                type: string

    Cluster:
      type: object
      required: [id, status, confidence, summary, ticket_count, created_at]
      properties:
        id:
          type: string
          format: uuid
        status:
          $ref: '#/components/schemas/ClusterStatus'
        confidence:
          $ref: '#/components/schemas/ConfidenceLevel'
        summary:
          type: string
        matching_signals:
          $ref: '#/components/schemas/MatchingSignals'
        primary_ticket_id:
          type: string
          format: uuid
        ticket_count:
          type: integer
        created_at:
          type: string
          format: date-time
        updated_at:
          type: string
          format: date-time
        expires_at:
          type: string
          format: date-time
          description: Auto-expire if not actioned
        created_by:
          type: string
          description: '"system" or user ID'

    ClusterDetail:
      allOf:
        - $ref: '#/components/schemas/Cluster'
        - type: object
          properties:
            tickets:
              type: array
              items:
                $ref: '#/components/schemas/Ticket'

    ClusterListResponse:
      type: object
      required: [data, meta]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Cluster'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    # ==================== MERGES ====================
    MergeRequest:
      type: object
      required: [cluster_id, primary_ticket_id, merge_behavior]
      properties:
        cluster_id:
          type: string
          format: uuid
        primary_ticket_id:
          type: string
          format: uuid
        merge_behavior:
          $ref: '#/components/schemas/MergeBehavior'

    MergeOperation:
      type: object
      required: [id, cluster_id, primary_ticket_id, secondary_ticket_ids, merge_behavior, status, performed_by, performed_at]
      properties:
        id:
          type: string
          format: uuid
        cluster_id:
          type: string
          format: uuid
        primary_ticket_id:
          type: string
          format: uuid
        secondary_ticket_ids:
          type: array
          items:
            type: string
            format: uuid
        merge_behavior:
          $ref: '#/components/schemas/MergeBehavior'
        status:
          $ref: '#/components/schemas/MergeStatus'
        performed_by:
          type: string
        performed_at:
          type: string
          format: date-time
        reverted_at:
          type: string
          format: date-time
        reverted_by:
          type: string
        revert_reason:
          type: string

    MergeListResponse:
      type: object
      required: [data, meta]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/MergeOperation'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    RevertConflictResponse:
      type: object
      required: [error, message, conflicts]
      properties:
        error:
          type: string
        message:
          type: string
        conflicts:
          type: array
          items:
            type: object
            properties:
              ticket_id:
                type: string
                format: uuid
              field:
                type: string
              original_value:
                type: string
              current_value:
                type: string

    # ==================== SPIKES ====================
    SpikeAlert:
      type: object
      required: [id, status, severity, field_name, field_value, current_count, baseline_count, percentage_increase, detected_at]
      properties:
        id:
          type: string
          format: uuid
        status:
          $ref: '#/components/schemas/SpikeStatus'
        severity:
          $ref: '#/components/schemas/SeverityLevel'
        field_name:
          type: string
        field_value:
          type: string
        current_count:
          type: integer
        baseline_count:
          type: number
        percentage_increase:
          type: number
        time_window_start:
          type: string
          format: date-time
        time_window_end:
          type: string
          format: date-time
        detected_at:
          type: string
          format: date-time
        acknowledged_by:
          type: string
        acknowledged_at:
          type: string
          format: date-time
        resolved_at:
          type: string
          format: date-time

    SpikeDetail:
      allOf:
        - $ref: '#/components/schemas/SpikeAlert'
        - type: object
          properties:
            affected_clusters:
              type: array
              items:
                $ref: '#/components/schemas/Cluster'

    SpikeListResponse:
      type: object
      required: [data, meta]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/SpikeAlert'
        meta:
          $ref: '#/components/schemas/PaginationMeta'

    # ==================== TRENDS ====================
    Driver:
      type: object
      required: [id, theme_summary, cluster_count, ticket_count]
      properties:
        id:
          type: string
          format: uuid
        theme_summary:
          type: string
        matching_pattern:
          type: object
        cluster_count:
          type: integer
        ticket_count:
          type: integer
        duplication_rate:
          type: number
        trend_direction:
          type: string
          enum: [up, down, stable]
        trend_percentage:
          type: number
        last_seen_at:
          type: string
          format: date-time

    TopDriversResponse:
      type: object
      required: [data, period]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Driver'
        period:
          type: string

    GrowingDriversResponse:
      type: object
      required: [data, compare_period]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Driver'
        compare_period:
          type: string

    DuplicatedDriversResponse:
      type: object
      required: [data, period]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/Driver'
        period:
          type: string

    # ==================== AUDIT ====================
    AuditEntry:
      type: object
      required: [id, action_type, actor_id, actor_type, resource_type, resource_id, outcome, created_at]
      properties:
        id:
          type: string
          format: uuid
        action_type:
          $ref: '#/components/schemas/AuditActionType'
        actor_id:
          type: string
        actor_type:
          type: string
          enum: [user, system]
        resource_type:
          type: string
        resource_id:
          type: string
          format: uuid
        related_ids:
          type: array
          items:
            type: string
            format: uuid
        metadata:
          type: object
        outcome:
          type: string
          enum: [success, failure]
        error_message:
          type: string
        ip_address:
          type: string
          description: Client IP address
        user_agent:
          type: string
          description: Client user agent
        created_at:
          type: string
          format: date-time

    AuditListResponse:
      type: object
      required: [data, meta]
      properties:
        data:
          type: array
          items:
            $ref: '#/components/schemas/AuditEntry'
        meta:
          $ref: '#/components/schemas/PaginationMeta'
